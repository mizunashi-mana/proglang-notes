\section{Haskell Parsing with PEG}

\cite{SimonMarlow:2010}

\subsection{Lexical Syntax}

\begin{align*}
  \begin{array}{rcl}
    {program}
    & \Coloneq & ({lexeme} \mid {whitespace})^* \\
    {lexeme}
    & \Coloneq & {qvarid} \\
    & \mid & {qconid} \\
    & \mid & {qvarsym} \\
    & \mid & {qconsym} \\
    & \mid & {literal} \\
    & \mid & {special} \\
    & \mid & {reservedop} \\
    & \mid & {reservedid} \\
    {literal}
    & \Coloneq & {integer} \\
    & \mid & {float} \\
    & \mid & {char} \\
    & \mid & {string} \\
    {special}
    & \Coloneq & \text{\texttt{\textquotedbl(\textquotedbl}}
    \mid \text{\texttt{\textquotedbl)\textquotedbl}}
    \mid \text{\texttt{\textquotedbl,\textquotedbl}}
    \mid \text{\texttt{\textquotedbl;\textquotedbl}}
    \mid \text{\texttt{\textquotedbl[\textquotedbl}}
    \mid \text{\texttt{\textquotedbl]\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textasciigrave\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\{\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\}\textquotedbl}}
    \\
    {whitespace}
    & \Coloneq & {whitestuff}^+
    \\
    {whitestuff}
    & \Coloneq & {whitechar}
    \mid {comment}
    \mid {ncomment}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {whitechar}
    & \Coloneq & {newline}
    \mid \text{\texttt{\textquotedbl\textbackslash v\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\;\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textbackslash t\textquotedbl}}
    \mid (\text{Unicode whitespace})
    \\
    {newline}
    & \Coloneq & \text{\texttt{\textquotedbl\textbackslash r\textbackslash n\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textbackslash r\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textbackslash n\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textbackslash f\textquotedbl}}
    \\
    {comment}
    & \Coloneq & {dashes}\; (! {symbol}\; {any}^*)^?\; {newline}
    \\
    {dashes}
    & \Coloneq & \text{\texttt{\textquotedbl-\textquotedbl}}\; (\text{\texttt{\textquotedbl-\textquotedbl}})^+
    \\
    {opencom}
    & \Coloneq & \text{\texttt{\textquotedbl\{-\textquotedbl}}
    \\
    {closecom}
    & \Coloneq & \text{\texttt{\textquotedbl-\}\textquotedbl}}
    \\
    {ncomment}
    & \Coloneq & {opencom}\; {ANYs}\; ({ncomment}\; {ANYs})^*\; {closecom}
    \\
    {ANYs}
    & \Coloneq & ! ({ANY}^*\; ({opencom} \mid {closecom})\; {ANY}^*)\; {ANY}^*
    \\
    {ANY}
    & \Coloneq & {graphic}
    \mid {whitechar}
    \\
    {any}
    & \Coloneq & {graphic}
    \mid \text{\texttt{\textquotedbl\;\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textbackslash t\textquotedbl}}
    \\
    {graphic}
    & \Coloneq & {small}
    \mid {large}
    \mid {symbol}
    \mid {digit}
    \mid {special}
    \mid \text{\texttt{\textquotedbl\textbackslash\textquotedbl\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textquotesingle\textquotedbl}}
    \\
    {small}
    & \Coloneq & \text{\texttt{\textquotedbl a\textquotedbl}} \mid \text{\texttt{\textquotedbl b\textquotedbl}} \mid \cdots \mid \text{\texttt{\textquotedbl z\textquotedbl}}
    \mid (\text{Unicode lowercase letter})
    \mid \text{\texttt{\textquotedbl\textunderscore\textquotedbl}}
    \\
    {large}
    & \Coloneq & \text{\texttt{\textquotedbl A\textquotedbl}} \mid \text{\texttt{\textquotedbl B\textquotedbl}} \mid \cdots \mid \text{\texttt{\textquotedbl Z\textquotedbl}}
    \mid (\text{Unicode uppercase letter})
    \mid (\text{Unicode titlecase letter})
    \\
    {symbol}
    & \Coloneq & \text{\texttt{\textquotedbl!\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\#\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\$\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\%\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\&\textquotedbl}}
    \mid \text{\texttt{\textquotedbl *\textquotedbl}}
    \mid \text{\texttt{\textquotedbl +\textquotedbl}}
    \mid \text{\texttt{\textquotedbl .\textquotedbl}}
    \mid \text{\texttt{\textquotedbl /\textquotedbl}}
    \mid \text{\texttt{\textquotedbl <\textquotedbl}}
    \mid \text{\texttt{\textquotedbl =\textquotedbl}}
    \mid \text{\texttt{\textquotedbl >\textquotedbl}}
    \\
    & \mid & \text{\texttt{\textquotedbl ?\textquotedbl}}
    \mid \text{\texttt{\textquotedbl @\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textbackslash\textbackslash\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textasciicircum\textquotedbl}}
    \mid \text{\texttt{\textquotedbl |\textquotedbl}}
    \mid \text{\texttt{\textquotedbl -\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textasciitilde\textquotedbl}}
    \mid \text{\texttt{\textquotedbl :\textquotedbl}}
    \\
    & \mid & ! ({symbol} \mid \text{\texttt{\textquotedbl\textunderscore\textquotedbl}} \mid \text{\texttt{\textquotedbl\textbackslash\textquotedbl\textquotedbl}} \mid \text{\texttt{\textquotedbl\textquotesingle\textquotedbl}})\; {uniSymbol}
    \\
    {uniSymbol}
    & \Coloneq & (\text{Unicode symbol})
    \mid (\text{Unicode punctuation})
    \\
    {digit}
    & \Coloneq & \text{\texttt{\textquotedbl0\textquotedbl}} \mid \text{\texttt{\textquotedbl1\textquotedbl}} \mid \cdots \mid \text{\texttt{\textquotedbl9\textquotedbl}}
    \mid (\text{Unicode decimal digit})
    \\
    {octit}
    & \Coloneq & \text{\texttt{\textquotedbl0\textquotedbl}} \mid \text{\texttt{\textquotedbl1\textquotedbl}} \mid \cdots \mid \text{\texttt{\textquotedbl7\textquotedbl}}
    \\
    {hexit}
    & \Coloneq & {digit}
    \mid \text{\texttt{\textquotedbl A\textquotedbl}} \mid \cdots \mid \text{\texttt{\textquotedbl F\textquotedbl}}
    \mid \text{\texttt{\textquotedbl a\textquotedbl}} \mid \cdots \mid \text{\texttt{\textquotedbl f\textquotedbl}}
    \\
    {varid}
    & \Coloneq & ! ({reservedid}\; !{other})\; {small}\; {other}^*
    \\
    {conid}
    & \Coloneq & {large}\; {other}^*
    \\
    {other}
    & \Coloneq & {small}
    \mid {large}
    \mid {digit}
    \mid \text{\texttt{\textquotedbl\textquotesingle\textquotedbl}}
    \\
    {reservedid}
    & \Coloneq & \text{\texttt{\textquotedbl case\textquotedbl}}
    \mid \text{\texttt{\textquotedbl class\textquotedbl}}
    \mid \text{\texttt{\textquotedbl data\textquotedbl}}
    \mid \text{\texttt{\textquotedbl default\textquotedbl}}
    \mid \text{\texttt{\textquotedbl deriving\textquotedbl}}
    \mid \text{\texttt{\textquotedbl do\textquotedbl}}
    \mid \text{\texttt{\textquotedbl else\textquotedbl}}
    \\
    & \mid & \text{\texttt{\textquotedbl foreign\textquotedbl}}
    \mid \text{\texttt{\textquotedbl if\textquotedbl}}
    \mid \text{\texttt{\textquotedbl import\textquotedbl}}
    \mid \text{\texttt{\textquotedbl in\textquotedbl}}
    \mid \text{\texttt{\textquotedbl infix\textquotedbl}}
    \mid \text{\texttt{\textquotedbl infixl\textquotedbl}}
    \mid \text{\texttt{\textquotedbl infixr\textquotedbl}}
    \\
    & \mid & \text{\texttt{\textquotedbl instance\textquotedbl}}
    \mid \text{\texttt{\textquotedbl let\textquotedbl}}
    \mid \text{\texttt{\textquotedbl module\textquotedbl}}
    \mid \text{\texttt{\textquotedbl newtype\textquotedbl}}
    \mid \text{\texttt{\textquotedbl of\textquotedbl}}
    \mid \text{\texttt{\textquotedbl then\textquotedbl}}
    \mid \text{\texttt{\textquotedbl type\textquotedbl}}
    \\
    & \mid & \text{\texttt{\textquotedbl where\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textunderscore\textquotedbl}}
    \\
    {varsym}
    & \Coloneq & {!} (({reservedop} \mid {dashes})\; !{symbol} \mid \text{\texttt{\textquotedbl :\textquotedbl}})\; {symbol}^+
    \\
    {consym}
    & \Coloneq & {!} ({reservedop}\; !{symbol})\; \text{\texttt{\textquotedbl :\textquotedbl}}\; {symbol}^+
    \\
    {reservedop}
    & \Coloneq & \text{\texttt{\textquotedbl ..\textquotedbl}}
    \mid \text{\texttt{\textquotedbl :\textquotedbl}}
    \mid \text{\texttt{\textquotedbl ::\textquotedbl}}
    \mid \text{\texttt{\textquotedbl =\textquotedbl}}
    \mid \text{\texttt{\textquotedbl \textbackslash\textbackslash\textquotedbl}}
    \mid \text{\texttt{\textquotedbl <-\textquotedbl}}
    \mid \text{\texttt{\textquotedbl ->\textquotedbl}}
    \mid \text{\texttt{\textquotedbl @\textquotedbl}}
    \mid \text{\texttt{\textquotedbl \textasciitilde\textquotedbl}}
    \mid \text{\texttt{\textquotedbl =>\textquotedbl}}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {tycon}
    & \Coloneq & {conid}
    \\
    {modid}
    & \Coloneq & ({conid}\; \text{\texttt{\textquotedbl .\textquotedbl}})^*\; {conid}
    \\
    {qvarid}
    & \Coloneq & ({modid}\; \text{\texttt{\textquotedbl .\textquotedbl}})^?\; {varid}
    \\
    {qconid}
    & \Coloneq & ({modid}\; \text{\texttt{\textquotedbl .\textquotedbl}})^?\; {conid}
    \\
    {qtycon}
    & \Coloneq & ({modid}\; \text{\texttt{\textquotedbl .\textquotedbl}})^?\; {conid}
    \\
    {qvarsym}
    & \Coloneq & ({modid}\; \text{\texttt{\textquotedbl .\textquotedbl}})^?\; {varsym}
    \\
    {qconsym}
    & \Coloneq & ({modid}\; \text{\texttt{\textquotedbl .\textquotedbl}})^?\; {consym}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {decimal}
    & \Coloneq & {digit}^+
    \\
    {octal}
    & \Coloneq & {octit}^+
    \\
    {hexdecimal}
    & \Coloneq & {hexit}^+
    \\
    {integer}
    & \Coloneq & {decimal} \\
    & \mid & \text{\texttt{\textquotedbl 0o\textquotedbl}}\; {octal} \mid \text{\texttt{\textquotedbl 0O\textquotedbl}}\; {octal} \\
    & \mid & \text{\texttt{\textquotedbl 0x\textquotedbl}}\; {hexdecimal} \mid \text{\texttt{\textquotedbl 0X\textquotedbl}}\; {hexdecimal}
    \\
    {float}
    & \Coloneq & {decimal}\; \text{\texttt{\textquotedbl .\textquotedbl}}\; {decimal}\; {exponent}^? \\
    & \mid & {decimal}\; {exponent}
    \\
    {exponent}
    & \Coloneq & (\text{\texttt{\textquotedbl e\textquotedbl}} \mid \text{\texttt{\textquotedbl E\textquotedbl}})\; (\text{\texttt{\textquotedbl +\textquotedbl}} \mid \text{\texttt{\textquotedbl -\textquotedbl}})\; {decimal}
    \\
    {char}
    & \Coloneq & \text{\texttt{\textquotedbl\textquotesingle\textquotedbl}}\;({!}(\text{\texttt{\textquotedbl\textquotesingle\textquotedbl}} \mid \text{\texttt{\textquotedbl\textbackslash\textbackslash\textquotedbl}})\; {graphic} \mid \text{\texttt{\textquotedbl\;\textquotedbl}} \mid {!}\text{\texttt{\textquotedbl\textbackslash\textbackslash\&\textquotedbl}}\; {escape}) \; \text{\texttt{\textquotedbl\textquotesingle\textquotedbl}}
    \\
    {string}
    & \Coloneq & \text{\texttt{\textquotedbl\textbackslash\textquotedbl\textquotedbl}}\;({!}(\text{\texttt{\textquotedbl\textbackslash\textquotedbl\textquotedbl}} \mid \text{\texttt{\textquotedbl\textbackslash\textbackslash\textquotedbl}})\; {graphic} \mid \text{\texttt{\textquotedbl\;\textquotedbl}} \mid {escape} \mid {gap})^* \; \text{\texttt{\textquotedbl\textbackslash\textquotedbl\textquotedbl}}
    \\
    {escape}
    & \Coloneq & \text{\texttt{\textquotedbl\textbackslash\textbackslash\textquotedbl}} ({charesc} \mid {ascii} \mid {decimal} \mid \text{\texttt{\textquotedbl o\textquotedbl}}\; {octal} \mid \text{\texttt{\textquotedbl x\textquotedbl}}\; {hexdecimal})
    \\
    {charesc}
    & \Coloneq & \text{\texttt{\textquotedbl a\textquotedbl}}
    \mid \text{\texttt{\textquotedbl b\textquotedbl}}
    \mid \text{\texttt{\textquotedbl f\textquotedbl}}
    \mid \text{\texttt{\textquotedbl n\textquotedbl}}
    \mid \text{\texttt{\textquotedbl r\textquotedbl}}
    \mid \text{\texttt{\textquotedbl t\textquotedbl}}
    \mid \text{\texttt{\textquotedbl v\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textbackslash\textbackslash\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textbackslash\textquotedbl\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textquotesingle\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\&\textquotedbl}}
    \\
    {ascii}
    & \Coloneq & \text{\texttt{\textquotedbl\textasciicircum\textquotedbl}}\; {cntrl}
    \mid \text{\texttt{\textquotedbl NUL\textquotedbl}}
    \mid \text{\texttt{\textquotedbl SOH\textquotedbl}}
    \mid \text{\texttt{\textquotedbl STX\textquotedbl}}
    \mid \text{\texttt{\textquotedbl ETX\textquotedbl}}
    \mid \text{\texttt{\textquotedbl EOT\textquotedbl}}
    \mid \text{\texttt{\textquotedbl ENQ\textquotedbl}}
    \mid \text{\texttt{\textquotedbl ACK\textquotedbl}}
    \mid \text{\texttt{\textquotedbl BEL\textquotedbl}}
    \mid \text{\texttt{\textquotedbl BS\textquotedbl}}
    \\
    & \mid & \text{\texttt{\textquotedbl HT\textquotedbl}}
    \mid \text{\texttt{\textquotedbl LF\textquotedbl}}
    \mid \text{\texttt{\textquotedbl VT\textquotedbl}}
    \mid \text{\texttt{\textquotedbl FF\textquotedbl}}
    \mid \text{\texttt{\textquotedbl CR\textquotedbl}}
    \mid \text{\texttt{\textquotedbl SO\textquotedbl}}
    \mid \text{\texttt{\textquotedbl SI\textquotedbl}}
    \mid \text{\texttt{\textquotedbl DLE\textquotedbl}}
    \mid \text{\texttt{\textquotedbl DC1\textquotedbl}}
    \mid \text{\texttt{\textquotedbl DC2\textquotedbl}}
    \mid \text{\texttt{\textquotedbl DC3\textquotedbl}}
    \\
    & \mid & \text{\texttt{\textquotedbl DC4\textquotedbl}}
    \mid \text{\texttt{\textquotedbl NAK\textquotedbl}}
    \mid \text{\texttt{\textquotedbl SYN\textquotedbl}}
    \mid \text{\texttt{\textquotedbl ETB\textquotedbl}}
    \mid \text{\texttt{\textquotedbl CAN\textquotedbl}}
    \mid \text{\texttt{\textquotedbl EM\textquotedbl}}
    \mid \text{\texttt{\textquotedbl SUB\textquotedbl}}
    \mid \text{\texttt{\textquotedbl ESC\textquotedbl}}
    \mid \text{\texttt{\textquotedbl FS\textquotedbl}}
    \mid \text{\texttt{\textquotedbl GS\textquotedbl}}
    \mid \text{\texttt{\textquotedbl RS\textquotedbl}}
    \\
    & \mid & \text{\texttt{\textquotedbl US\textquotedbl}}
    \mid \text{\texttt{\textquotedbl SP\textquotedbl}}
    \mid \text{\texttt{\textquotedbl DEL\textquotedbl}}
    \\
    {cntrl}
    & \Coloneq & \text{\texttt{\textquotedbl A\textquotedbl}} \mid \text{\texttt{\textquotedbl B\textquotedbl}} \mid \cdots \mid \text{\texttt{\textquotedbl Z\textquotedbl}}
    \mid \text{\texttt{\textquotedbl @\textquotedbl}}
    \mid \text{\texttt{\textquotedbl [\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textbackslash\textbackslash\textquotedbl}}
    \mid \text{\texttt{\textquotedbl ]\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textasciicircum\textquotedbl}}
    \mid \text{\texttt{\textquotedbl\textunderscore\textquotedbl}}
    \\
    {gap}
    & \Coloneq & \text{\texttt{\textquotedbl\textbackslash\textbackslash\textquotedbl}}\; {whitechar}^+\; \text{\texttt{\textquotedbl\textbackslash\textbackslash\textquotedbl}}
  \end{array}
\end{align*}

\subsection{Preprocess for Layout}

\begin{align*}
  L
\end{align*}

\subsection{PEG with Layout Tokens}

\begin{align*}
  \begin{array}{rcl}
    {module}
    & \Coloneq & \text{\texttt{\textquotedbl module\textquotedbl}}\; {modid}\; {exports}^?\; \text{\texttt{\textquotedbl where\textquotedbl}}\; {body} \\
    & \mid & {body} \\
    {body}
    & \Coloneq & {expbo}\; {bodyinl}\; {expbc} \\
    & \mid & {impbo}\; {bodyinl}\; {impbc} \\
    {bodyinl}
    & \Coloneq & {impdecls}\; ;\; {topdecls} \\
    & \mid & {impdecls} \\
    & \mid & {topdecls} \\
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {exports}
    & \Coloneq & \text{\texttt{\textquotedbl(\textquotedbl}}\; ({export}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {export}^?\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {export}
    & \Coloneq & {qvar} \\
    & \mid & {qtycon}\; (\text{\texttt{\textquotedbl(\textquotedbl}}\; (\text{\texttt{\textquotedbl..\textquotedbl}} \mid ({cname}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {cname} \mid )\; \text{\texttt{\textquotedbl)\textquotedbl}})^? \\
    & \mid & \text{\texttt{\textquotedbl module\textquotedbl}}\; {modid} \\
    {impdecl}
    & \Coloneq & \text{\texttt{\textquotedbl import\textquotedbl}}\; \text{\texttt{\textquotedbl qualified\textquotedbl}}^?\; {modid}\; (\text{\texttt{\textquotedbl as\textquotedbl}}\; {modid})^?\; {impspec}^? \\
    & \mid & \\
    {impspec}
    & \Coloneq & \text{\texttt{\textquotedbl(\textquotedbl}}\; ({import}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {import}^?\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl hiding\textquotedbl}}\;\text{\texttt{\textquotedbl(\textquotedbl}}\; ({import}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {import}^?\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {import}
    & \Coloneq & {var} \\
    & \mid & {tycon}\; (\text{\texttt{\textquotedbl(\textquotedbl}}\; (\text{\texttt{\textquotedbl..\textquotedbl}} \mid ({cname}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {cname} \mid )\; \text{\texttt{\textquotedbl)\textquotedbl}})^? \\
    {cname}
    & \Coloneq & {var} \mid {con}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {topdecls}
    & \Coloneq & ({topdecl}\; ;)^*\; {topdecl} \mid \\
    {topdecl}
    & \Coloneq & \text{\texttt{\textquotedbl type\textquotedbl}}\; {simpletype}\; \text{\texttt{\textquotedbl =\textquotedbl}}\; {type} \\
    & \mid & \text{\texttt{\textquotedbl data\textquotedbl}}\; ({context}\; \text{\texttt{\textquotedbl =>\textquotedbl}})^?\; {simpletype}\; (\text{\texttt{\textquotedbl =\textquotedbl}}\; {constrs})^?\; {deriving}^? \\
    & \mid & \text{\texttt{\textquotedbl newtype\textquotedbl}}\; ({context}\; \text{\texttt{\textquotedbl =>\textquotedbl}})^?\; {simpletype}\; \text{\texttt{\textquotedbl =\textquotedbl}}\; {newconstr}\; {deriving}^? \\
    & \mid & \text{\texttt{\textquotedbl class\textquotedbl}}\; ({scontext}\; \text{\texttt{\textquotedbl =>\textquotedbl}})^?\; {tycon}\; {tyvar}\; (\text{\texttt{\textquotedbl where\textquotedbl}}\; {cdecls})^? \\
    & \mid & \text{\texttt{\textquotedbl instance\textquotedbl}}\; ({scontext}\; \text{\texttt{\textquotedbl =>\textquotedbl}})^?\; {qtycon}\; {inst}\; (\text{\texttt{\textquotedbl where\textquotedbl}}\; {idecls})^? \\
    & \mid & \text{\texttt{\textquotedbl default\textquotedbl}}\; \text{\texttt{\textquotedbl(\textquotedbl}}\; (({type}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {type} \mid )\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl foreign\textquotedbl}}\; {fdecl} \\
    & \mid & {decl}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {decls}
    & \Coloneq & {expbo}\; {declsinl}\; {expbc} \\
    & \mid & {impbo}\; {declsinl}\; {impbc} \\
    {declsinl}
    & \Coloneq & ({decl}\; \text{\texttt{\textquotedbl;\textquotedbl}})^*\; {decl} \mid \\
    {decl}
    & \Coloneq & {gendecl} \\
    & \mid & ({funlhs} \mid {pat})\; {rhs} \\
    {cdecls}
    & \Coloneq & {expbo}\; {cdeclsinl}\; {expbc} \\
    & \mid & {impbo}\; {cdeclsinl}\; {impbc} \\
    {cdeclsinl}
    & \Coloneq & ({cdecl}\; \text{\texttt{\textquotedbl;\textquotedbl}})^*\; {cdecl} \mid \\
    {cdecl}
    & \Coloneq & {gendecl} \\
    & \mid & ({funlhs} \mid {var})\; {rhs} \\
    {idecls}
    & \Coloneq & {expbo}\; {ideclsinl}\; {expbc} \\
    & \mid & {impbo}\; {ideclsinl}\; {impbc} \\
    {ideclsinl}
    & \Coloneq & ({idecl}\; \text{\texttt{\textquotedbl;\textquotedbl}})^*\; {idecl} \mid \\
    {idecl}
    & \Coloneq & ({funlhs} \mid {var})\; {rhs} \\
    & \mid & \\
    {gendecl}
    & \Coloneq & {vars}\; \text{\texttt{\textquotedbl ::\textquotedbl}}\; ({context}\; \text{\texttt{\textquotedbl =>\textquotedbl}})^?\; {type} \\
    & \mid & {fixity}\; {integer}^?\; {ops} \\
    & \mid & \\
    {ops}
    & \Coloneq & ({op}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {op} \\
    {vars}
    & \Coloneq & ({var}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {var} \\
    {fixity}
    & \Coloneq & \text{\texttt{\textquotedbl infixl\textquotedbl}}
    \mid \text{\texttt{\textquotedbl infixr\textquotedbl}}
    \mid \text{\texttt{\textquotedbl infix\textquotedbl}}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {type}
    & \Coloneq & {btype}\; (\text{\texttt{\textquotedbl ->\textquotedbl}}\; {type})^? \\
    {btype}
    & \Coloneq & {btype}^?\; {atype} \\
    {atype}
    & \Coloneq & {gtycon} \\
    & \mid & {tyvar} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; ({type}\; \text{\texttt{\textquotedbl,\textquotedbl}})^+\; {type}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl[\textquotedbl}}\; {type}\; \text{\texttt{\textquotedbl]\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; {type}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {gtycon}
    & \Coloneq & {qtycon} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl[\textquotedbl}}\; \text{\texttt{\textquotedbl]\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; \text{\texttt{\textquotedbl ->\textquotedbl}}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; \text{\texttt{\textquotedbl,\textquotedbl}}^+\; \text{\texttt{\textquotedbl)\textquotedbl}}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {context}
    & \Coloneq & {class} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; (({class}\; \text{\texttt{\textquotedbl,\textquotedbl}})\; {class} \mid )\; \text{\texttt{\textquotedbl)\textquotedbl}}
    \\
    {class}
    & \Coloneq & {qtycon}\; {tyvar} \\
    & \mid & {qtycon}\; \text{\texttt{\textquotedbl(\textquotedbl}}\; {tyvar}\; {atype}^+\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {scontext}
    & \Coloneq & {simpleclass} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; (({simpleclass}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {simpleclass} \mid )\; \text{\texttt{\textquotedbl)\textquotedbl}}
    \\
    {simpleclass}
    & \Coloneq & {qtycon}\; {tyvar}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {simpletype}
    & \Coloneq & {tycon}\; {tyvar}^* \\
    {constrs}
    & \Coloneq & ({constr}\; \text{\texttt{\textquotedbl|\textquotedbl}})^*\; {constr} \\
    {constr}
    & \Coloneq & {con}\; {expbo}\; (({fielddecl}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {fielddecl} \mid )\; {expbc} \\
    & \mid & ({btype} \mid \text{\texttt{\textquotedbl!\textquotedbl}}\; {atype})\; {conop}\; ({btype} \mid \text{\texttt{\textquotedbl!\textquotedbl}}\; {atype}) \\
    & \mid & {con}\; (\text{\texttt{\textquotedbl!\textquotedbl}}^?\; {atype})^* \\
    {newconstr}
    & \Coloneq & {con}\; {expbo}\; {var}\; \text{\texttt{\textquotedbl ::\textquotedbl}}\; {type}\; {expbc} \\
    & \mid & {con}\; {atype} \\
    {fielddecl}
    & \Coloneq & {vars}\; \text{\texttt{\textquotedbl ::\textquotedbl}}\; ({type} \mid \text{\texttt{\textquotedbl !\textquotedbl}}\; {atype}) \\
    {deriving}
    & \Coloneq & \text{\texttt{\textquotedbl deriving\textquotedbl}}\; {dclass} \\
    & \mid & \text{\texttt{\textquotedbl deriving\textquotedbl}}\; \text{\texttt{\textquotedbl(\textquotedbl}}\; ({dclass}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {dclass} \mid )\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {dclass}
    & \Coloneq & {qtycon} \\
    {inst}
    & \Coloneq & {qtycon} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; {gtycon}\; {tyvar}^*\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; ({tyvar}\; \text{\texttt{\textquotedbl,\textquotedbl}})^+\; {tyvar}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl[\textquotedbl}}\; {tyvar}\; \text{\texttt{\textquotedbl]\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; {tyvar}\; \text{\texttt{\textquotedbl ->\textquotedbl}}\; {tyvar}\; \text{\texttt{\textquotedbl)\textquotedbl}}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {fdecl}
    & \Coloneq & \text{\texttt{\textquotedbl import\textquotedbl}}\; {callconv}\; {safety}^?\; {impent}\; {var}\; \text{\texttt{\textquotedbl ::\textquotedbl}}\; {ftype} \\
    & \mid & \text{\texttt{\textquotedbl export\textquotedbl}}\; {callconv}\; {expent}\; {var}\; \text{\texttt{\textquotedbl ::\textquotedbl}}\; {ftype} \\
    {callconv}
    & \Coloneq & \text{\texttt{\textquotedbl ccall\textquotedbl}}
    \mid \text{\texttt{\textquotedbl stdcall\textquotedbl}}
    \mid \text{\texttt{\textquotedbl cplusplus\textquotedbl}}
    \mid \text{\texttt{\textquotedbl jvm\textquotedbl}}
    \mid \text{\texttt{\textquotedbl dotnet\textquotedbl}}
    \\
    & \mid & (\text{system-specific calling conventions}) \\
    {impent}
    & \Coloneq & {string}^? \\
    {expent}
    & \Coloneq & {string}^? \\
    {safety}
    & \Coloneq & \text{\texttt{\textquotedbl unsafe\textquotedbl}}
    \mid \text{\texttt{\textquotedbl safe\textquotedbl}}
    \\
    {ftype}
    & \Coloneq & {fatype}\; \text{\texttt{\textquotedbl ->\textquotedbl}}\; {ftype} \\
    & \mid & {frtype} \\
    {frtype}
    & \Coloneq & {fatype} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {fatype}
    & \Coloneq & {qtycon}\; {atype}^*
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {funlhs}
    & \Coloneq & {var}\; {apat}^+ \\
    & \mid & {pat}\; {varop}\; {pat} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; {funlhs}\; \text{\texttt{\textquotedbl)\textquotedbl}}\; {apat}^+ \\
    {rhs}
    & \Coloneq & \text{\texttt{\textquotedbl =\textquotedbl}}\; {exp}\; (\text{\texttt{\textquotedbl where\textquotedbl}}\; {decls})^? \\
    & \mid & {gdrhs}\; (\text{\texttt{\textquotedbl where\textquotedbl}}\; {decls})^? \\
    {gdrhs}
    & \Coloneq & {guards}\; \text{\texttt{\textquotedbl =\textquotedbl}}\; {exp}\; {gdrhs}^? \\
    {guards}
    & \Coloneq & ({guard}\; \text{\texttt{\textquotedbl ,\textquotedbl}})^*\; {guard} \mid \\
    {guard}
    & \Coloneq & {pat}\; \text{\texttt{\textquotedbl <-\textquotedbl}}\; {infixexp} \\
    & \mid & \text{\texttt{\textquotedbl let\textquotedbl}}\; {decls} \\
    & \mid & {infixexp}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {exp}
    & \Coloneq & {infixexp}\; \text{\texttt{\textquotedbl ::\textquotedbl}}\; ({context}\; \text{\texttt{\textquotedbl =>\textquotedbl}})\; {type} \\
    & \mid & {infixexp} \\
    {infixexp}
    & \Coloneq & \text{\texttt{\textquotedbl -\textquotedbl}}\; {infixexp} \\
    & \mid & {lexp}\; {qop}\; {infixexp} \\
    & \mid & {lexp} \\
    {lexp}
    & \Coloneq & \text{\texttt{\textquotedbl\textbackslash\textbackslash\textquotedbl}}\; {apat}^+\; \text{\texttt{\textquotedbl ->\textquotedbl}}\; {exp} \\
    & \mid & \text{\texttt{\textquotedbl let\textquotedbl}}\; {decls}\; \text{\texttt{\textquotedbl in\textquotedbl}}\; {exp} \\
    & \mid & \text{\texttt{\textquotedbl if\textquotedbl}}\; {exp}\; \text{\texttt{\textquotedbl ;\textquotedbl}}^?\; \text{\texttt{\textquotedbl then\textquotedbl}}\; {exp}\; \text{\texttt{\textquotedbl ;\textquotedbl}}^?\; \text{\texttt{\textquotedbl else\textquotedbl}}\; {exp} \\
    & \mid & \text{\texttt{\textquotedbl case\textquotedbl}}\; {exp}\; \text{\texttt{\textquotedbl of\textquotedbl}}\; {casealts} \\
    & \mid & \text{\texttt{\textquotedbl do\textquotedbl}}\; {dostmts} \\
    & \mid & {fexp} \\
    {fexp}
    & \Coloneq & {fexp}^?\; {aexp} \\
    {aexp}
    & \Coloneq & {literal} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; {exp}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; ({exp}\; \text{\texttt{\textquotedbl,\textquotedbl}})^+\; {exp}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl[\textquotedbl}}\; ({exp}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {exp}\; \text{\texttt{\textquotedbl]\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl[\textquotedbl}}\; {exp}\; (\text{\texttt{\textquotedbl,\textquotedbl}}\; {exp})^?\; \text{\texttt{\textquotedbl..\textquotedbl}}\; {exp}^?\; \text{\texttt{\textquotedbl]\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl[\textquotedbl}}\; {exp}\; \text{\texttt{\textquotedbl|\textquotedbl}}\; ({qual}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {qual}\; \text{\texttt{\textquotedbl]\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; {infixexp}\; {qop}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; ! (\text{\texttt{\textquotedbl-\textquotedbl}}\; {infixexp})\; {qop}\; {infixexp}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & {qcon}\; {expbo}\; (({fbind}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {fbind} \mid )\; {expbc} \\
    & \mid & !({qcon}\; \text{\texttt{\textquotedbl\{\textquotedbl}})\; {aexp}\; {expbo}\; (({fbind}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {fbind} \mid )\; {expbc} \\
    & \mid & {qvar} \\
    & \mid & {gcon}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {qual}
    & \Coloneq & {pat}\; \text{\texttt{\textquotedbl <-\textquotedbl}}\; {exp} \\
    & \mid & \text{\texttt{\textquotedbl let\textquotedbl}}\; {decls} \\
    & \mid & {exp} \\
    {casealts}
    & \Coloneq & {expbo}\; {alts}\; {expbc} \\
    & \mid & {impbo}\; {alts}\; {impbc} \\
    {alts}
    & \Coloneq & ({alt}\; \text{\texttt{\textquotedbl;\textquotedbl}})^*\; {alt} \\
    {alt}
    & \Coloneq & {pat}\; \text{\texttt{\textquotedbl->\textquotedbl}}\; {exp}\; (\text{\texttt{\textquotedbl where\textquotedbl}}\; {decls})^? \\
    & \mid & {pat}\; {gdpat}\; (\text{\texttt{\textquotedbl where\textquotedbl}}\; {decls})^? \\
    & \mid & \\
    {gdpat}
    & \Coloneq & {guards}\; \text{\texttt{\textquotedbl->\textquotedbl}}\; {exp}\; {gdpat}^? \\
    {dostmts}
    & \Coloneq & {expbo}\; {stmts}\; {expbc} \\
    & \mid & {impbo}\; {stmts}\; {impbc} \\
    {stmts}
    & \Coloneq & {stmt}^*\; {exp}\; \text{\texttt{\textquotedbl;\textquotedbl}}^? \\
    {stmt}
    & \Coloneq & {exp}\; \text{\texttt{\textquotedbl;\textquotedbl}} \\
    & \mid & {pat}\; \text{\texttt{\textquotedbl <-\textquotedbl}}\; {exp}\; \text{\texttt{\textquotedbl;\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl let\textquotedbl}}\; {decls}\; \text{\texttt{\textquotedbl;\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl;\textquotedbl}} \\
    {fbind}
    & \Coloneq & {qvar}\; \text{\texttt{\textquotedbl =\textquotedbl}}\; {exp}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {pat}
    & \Coloneq & {lpat}\; {qconop}\; {pat} \\
    & \mid & {lpat} \\
    {lpat}
    & \Coloneq & \text{\texttt{\textquotedbl -\textquotedbl}}\; ({integer} \mid {float}) \\
    & \mid & {gcon}\; {apat}^+ \\
    & \mid & {apat} \\
    {apat}
    & \Coloneq & {var}\; (\text{\texttt{\textquotedbl @\textquotedbl}}\; {apat})^? \\
    & \mid & {literal} \\
    & \mid & \text{\texttt{\textquotedbl\textunderscore\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; {pat}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; ({pat}\; \text{\texttt{\textquotedbl,\textquotedbl}})^+\; {pat}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl[\textquotedbl}}\; ({pat}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {pat}\; \text{\texttt{\textquotedbl]\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl\textasciicircum\textquotedbl}}\; {apat} \\
    & \mid & {qcon}\; {expbo}\; (({fpat}\; \text{\texttt{\textquotedbl,\textquotedbl}})^*\; {fpat} \mid )\; {expbc} \\
    & \mid & {gcon} \\
    {fpat}
    & \Coloneq & {qvar}\; \text{\texttt{\textquotedbl =\textquotedbl}}\; {pat}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rcl}
    {gcon}
    & \Coloneq & \text{\texttt{\textquotedbl(\textquotedbl}}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl[\textquotedbl}}\; \text{\texttt{\textquotedbl]\textquotedbl}} \\
    & \mid & \text{\texttt{\textquotedbl(\textquotedbl}}\; \text{\texttt{\textquotedbl,\textquotedbl}}^+\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    & \mid & {qcon} \\
    {var}
    & \Coloneq & {varid} \mid \text{\texttt{\textquotedbl(\textquotedbl}}\; {varsym}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {qvar}
    & \Coloneq & {qvarid} \mid \text{\texttt{\textquotedbl(\textquotedbl}}\; {qvarsym}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {con}
    & \Coloneq & {conid} \mid \text{\texttt{\textquotedbl(\textquotedbl}}\; {consym}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {qcon}
    & \Coloneq & {qconid} \mid \text{\texttt{\textquotedbl(\textquotedbl}}\; {gconsym}\; \text{\texttt{\textquotedbl)\textquotedbl}} \\
    {varop}
    & \Coloneq & {varsym} \mid \text{\texttt{\textquotedbl\textasciigrave\textquotedbl}}\; {varid}\; \text{\texttt{\textquotedbl\textasciigrave\textquotedbl}} \\
    {qvarop}
    & \Coloneq & {qvarsym} \mid \text{\texttt{\textquotedbl\textasciigrave\textquotedbl}}\; {qvarid}\; \text{\texttt{\textquotedbl\textasciigrave\textquotedbl}} \\
    {conop}
    & \Coloneq & {consym} \mid \text{\texttt{\textquotedbl\textasciigrave\textquotedbl}}\; {conid}\; \text{\texttt{\textquotedbl\textasciigrave\textquotedbl}} \\
    {qvarop}
    & \Coloneq & {gconsym} \mid \text{\texttt{\textquotedbl\textasciigrave\textquotedbl}}\; {qconid}\; \text{\texttt{\textquotedbl\textasciigrave\textquotedbl}} \\
    {op}
    & \Coloneq & {varop} \mid {conop} \\
    {qop}
    & \Coloneq & {qvarop} \mid {qconop} \\
    {gconsym}
    & \Coloneq & \text{\texttt{\textquotedbl :\textquotedbl}} \mid {qconsym}
  \end{array}
\end{align*}

\begin{align*}
  \begin{array}{rclll}
    {expbo}
    & \Coloneq & \{l\} &\text{\texttt{\textquotedbl\{\textquotedbl}} &\{\text{\texttt{\textquotedbl\{\textquotedbl}}:l\} \\
    {expbc}
    & \Coloneq & \{\text{\texttt{\textquotedbl\{\textquotedbl}}:l\} &\text{\texttt{\textquotedbl\}\textquotedbl}} &\{l\} \\
    {impbo}
    & \Coloneq & \{l\} & \langle n\rangle &\{\langle n\rangle:l\} \\
    {impbc}
    & \Coloneq & \{\langle m\rangle:l\} &\epsilon &\{l\} \\
    {semi}
    & \Coloneq & &\text{\texttt{\textquotedbl ;\textquotedbl}} \\
    & \mid & \{\langle m\rangle:l\} & \langle n\rangle &\{\langle m\rangle:l \mid m = n\}
  \end{array}
\end{align*}

\begin{align*}
  \mathrm{skip}(l, t) &= \left\{\begin{array}{ll}
    \mathrm{true} &(l = \langle m\rangle:l' \land t = \langle n\rangle \land m < n) \\
    \mathrm{false} &(\text{otherwise})
  \end{array}\right.
\end{align*}
